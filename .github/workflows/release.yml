name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build and Release
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build
        run: make build

      - name: Archive Binary
        run: |
          mkdir -p dist
          cp .build/mac-menu dist/
          cd dist
          tar -czf mac-menu.tar.gz mac-menu

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/mac-menu.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew Formula
        run: |
          VERSION=${{ github.ref_name }}
          URL="https://github.com/sadiksaifi/mac-menu/releases/download/${VERSION}/mac-menu.tar.gz"
          SHA256=$(shasum -a 256 dist/mac-menu.tar.gz | awk '{print $1}')

          # Update Formula file
          sed -i '' "s|url \".*\"|url \"$URL\"|" Formula/mac-menu.rb
          sed -i '' "s|sha256 \".*\"|sha256 \"$SHA256\"|" Formula/mac-menu.rb

          # Commit and push
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/mac-menu.rb
          git commit -m "chore: update formula for $VERSION"
          git push origin HEAD:main

          echo "âœ… $VERSION formula updated and pushed"
